(()=>{var T=(a,t)=>()=>(a&&(t=a(a=0)),t);var Wt=(a,t)=>()=>(t||a((t={exports:{}}).exports,t),t.exports);var k,tt=T(()=>{k=class{constructor(t,i){this.handler=t,this.ws=new WebSocket(`ws://${i}/`),this.inbound=[],this._switchingClose=!1,this.ws.onopen=()=>{console.log("Connected to World Server!")},this.ws.onclose=e=>{let l=e.code===4001||e.reason.startsWith("Switching");console.log("[NetworkHandler] onclose",e.code,e.reason,"switchingClose =",this._switchingClose),!this._switchingClose&&!l&&this.handler!=null&&this.handler.game.stop(e)},this.ws.onmessage=e=>{try{let l=JSON.parse(e.data);this.inbound.push(l)}catch(l){console.error("[ERROR] Reading Packet => "+e.data),console.error(`->    ${l}`)}},this.ws.onerror=e=>{console.error(`[ERROR] ${e}`)}}close(t=1e3,i="Client Quit"){this._switchingClose=!1,console.log("[NetworkHandler] switchclose called, readyState =",this.ws.readyState);try{this.ws.close(t,i)}catch{console.log("ERROR TRYING TO CLOSE SOCKET")}}switchclose(){this._switchingClose=!0;try{this.ws.close(1e3,"Switching Server!")}catch{console.log("ERROR TRYING TO CLOSE SOCKET")}}waitForOpen(t=2e3){return this.ws.readyState===WebSocket.OPEN?Promise.resolve():new Promise((i,e)=>{let l=()=>{n(),i()},s=f=>{n(),e(f)},d=()=>{n(),e(new Error("WS open timeout"))},n=()=>{this.ws.removeEventListener("open",l),this.ws.removeEventListener("error",s),clearTimeout(c)};this.ws.addEventListener("open",l,{once:!0}),this.ws.addEventListener("error",s,{once:!0});let c=setTimeout(d,t)})}waitForLoginVerify(t=()=>!0,i=2e3){return new Promise((e,l)=>{let s=p=>{let g=p.data;if(typeof g=="string")try{g=JSON.parse(g)}catch{return}t(g)&&f(e,g)},d=()=>f(l,new Error("WS error")),n=p=>f(l,new Error(`WS closed ${p.code} ${p.reason||""}`)),c=()=>f(l,new Error("WS wait timeout")),f=(p,g)=>{this.ws.removeEventListener("message",s),this.ws.removeEventListener("error",d),this.ws.removeEventListener("close",n),clearTimeout(u),p(g)};this.ws.addEventListener("message",s),this.ws.addEventListener("error",d,{once:!0}),this.ws.addEventListener("close",n,{once:!0});let u=setTimeout(c,i)})}send(t,i){let e={type:t,data:i};this.ws.send(JSON.stringify(e))}}});var _,ht=T(()=>{Y();_=class{constructor(){}init(t,i,e,l,s,d,n,c,f,u){this.state=I.LOADING,this.game=t,this.net=i,this.player=e,this.world=l,this.EM=s,this.IM=d,this.CM=n,this.PH=c,this.AM=f,this.debug=u,this.GAME_WIDTH=1500,this.GAME_HEIGHT=640}updateSize(t,i){this.GAME_WIDTH=t,this.GAME_HEIGHT=i}}});var y,U=T(()=>{y=class a{static tileWidth=64;static tilePixelWidth=16;constructor(t,i,e,l,s,d,n=60){this.codename=i,this.handler=t,this.name=e,this.isSolid=l,this.loreBlurb=s,this.mapColor=d,this.frames=Math.trunc(t.AM.get(this.codename).naturalWidth/a.tilePixelWidth),this.frames>1&&(this.animationSpeed=n,this.animationIndex=0,this.animationI=0)}tick(){this.animationI+=1,this.animationI>=this.animationSpeed&&(this.animationI=0,this.animationIndex+=1,this.animationIndex>=this.frames&&(this.animationIndex=0))}render(t,i,e){this.frames>1?t.drawImage(this.handler.AM.get(this.codename),this.animationIndex*a.tilePixelWidth,0,16,16,i,e,a.tileWidth,a.tileWidth):t.drawImage(this.handler.AM.get(this.codename),i,e,a.tileWidth,a.tileWidth)}renderDebug(t,i,e){t.fillStyle="black",t.lineWidth=2,t.strokeRect(i+1,e+1,a.tileWidth-2,a.tileWidth-2),this.frames>1&&(t.font="16px monospace",t.fillStyle="black",t.fillText(`${this.animationIndex}`,i+2,e+16))}}});var W,D=T(()=>{U();W=class{constructor(t,i,e,l,s){this.handler=t,this.x=i,this.y=e,this.width=l,this.height=s,console.log("New Entity created!")}tick(){}render(t){}renderDebug(t){t.fillStyle="black",t.lineWidth=2,t.strokeRect(this.renderX-1,this.renderY-1,this.width+1,this.height+1)}handleCollisions(t,i,e){let l=!1,s=y.tileWidth,d=1e-6;if(i>0){let n=this.y,c=this.y+this.height-d,f=this.x+this.width+i,u=Math.trunc(f/s),p=Math.trunc(n/s),g=Math.trunc(c/s),w=i;for(let E=p;E<=g;E++){let m=this.handler.world.getTileAtWorldCoords(u,E);if(m&&m.isSolid){let x=u*s-(this.x+this.width);x<w&&(w=x)}}this.x+=w}else if(i<0){let n=this.y,c=this.y+this.height-d,f=this.x+i,u=Math.trunc(f/s),p=Math.trunc(n/s),g=Math.trunc(c/s),w=i;for(let E=p;E<=g;E++){let m=this.handler.world.getTileAtWorldCoords(u,E);if(m&&m.isSolid){let x=(u+1)*s-this.x;x>w&&(w=x)}}this.x+=w}if(e>0){let n=this.x,c=this.x+this.width-d,f=this.y+this.height+e,u=Math.trunc(f/s),p=Math.trunc(n/s),g=Math.trunc(c/s),w=e;for(let E=p;E<=g;E++){let m=this.handler.world.getTileAtWorldCoords(E,u);if(m&&m.isSolid){let x=u*s-(this.y+this.height);x<w&&(w=x)}}this.y+=w}else if(e<0){let n=this.x,c=this.x+this.width-d,f=this.y+e,u=Math.trunc(f/s),p=Math.trunc(n/s),g=Math.trunc(c/s),w=e;for(let E=p;E<=g;E++){let m=this.handler.world.getTileAtWorldCoords(E,u);if(m&&m.isSolid){let x=(u+1)*s-this.y;x>w&&(w=x)}}this.y+=w}}}});var M,R=T(()=>{D();M=class a extends W{static PLAYER_WIDTH=40;static PLAYER_HEIGHT=40;constructor(t,i,e,l,s,d){super(t,i,e,a.PLAYER_WIDTH,a.PLAYER_HEIGHT),this.session_id=l,this.username=s,this.color=d,this.renderX=0,this.renderY=0}tick(){this.renderX=this.x-this.handler.world.xOffset,this.renderY=this.y-this.handler.world.yOffset}render(t){t.fillStyle=this.color,t.fillRect(this.renderX,this.renderY,this.width,this.height),t.fillStyle="black",t.font="bold 20px monospace",t.fillText(this.username,this.renderX,this.renderY-5)}}});var v,F=T(()=>{D();R();v=class extends W{constructor(t,i,e){super(t,1e3,1e3,M.PLAYER_WIDTH,M.PLAYER_HEIGHT),this.renderX=0,this.renderY=0,this.speed=5,this.username=i,this.color=e,this.xMove=0,this.yMove=0}tick(){var t=!1;if(this.handler.CM.controls.get("UP").down()&&(this.yMove-=this.speed,t=!0),this.handler.CM.controls.get("LEFT").down()&&(this.xMove-=this.speed,t=!0),this.handler.CM.controls.get("DOWN").down()&&(this.yMove+=this.speed,t=!0),this.handler.CM.controls.get("RIGHT").down()&&(this.xMove+=this.speed,t=!0),this.xMove!=0&&this.yMove!=0){let e=.7071067812;this.xMove=this.xMove*e,this.yMove=this.yMove*e}this.handleCollisions(null,this.xMove,this.yMove),this.xMove=0,this.yMove=0;let i={x:this.x,y:this.y};t&&this.handler.net.send("move",i),this.renderX=this.x-this.handler.world.xOffset,this.renderY=this.y-this.handler.world.yOffset}render(t){t.fillStyle=this.color,t.fillRect(this.renderX,this.renderY,this.width,this.height),this.username!=null&&(t.fillStyle="black",t.font="bold 20px monospace",t.fillText(this.username,this.renderX,this.renderY-5))}}});var X,nt=T(()=>{U();X=class{constructor(t){this.handler=t,this.worldName=null,this.worldData=null,this.worldWidth=null,this.worldHeight=null,this.worldPixelWidth=null,this.worldPixelHeight=null,this.nameID="",this.CANVAS_WIDTH=1500,this.CANVAS_HEIGHT=640,this.xOffset=null,this.yOffset=null,this.tileMap=new Map,this.staticsRegistry=null}tick(){if(this.CANVAS_WIDTH=Math.floor(this.handler.GAME_WIDTH),this.CANVAS_HEIGHT=Math.floor(this.handler.GAME_HEIGHT),this.worldData!=null)for(let e=0;e<this.tileMap.size;e++)this.tileMap.get(e).tick();let t=this.worldPixelWidth-this.CANVAS_WIDTH,i=this.worldPixelHeight-this.CANVAS_HEIGHT;this.xOffset=Math.round(this.handler.player.x-this.CANVAS_WIDTH/2),this.yOffset=Math.round(this.handler.player.y-this.CANVAS_HEIGHT/2),this.xOffset=Math.max(0,Math.min(this.xOffset,t)),this.yOffset=Math.max(0,Math.min(this.yOffset,i))}render(t){if(this.worldData!=null){let i=Math.max(0,Math.floor(this.xOffset/y.tileWidth)+0),e=Math.max(0,Math.floor(this.yOffset/y.tileWidth)+0),l=Math.min(Math.floor((this.xOffset+this.CANVAS_WIDTH)/y.tileWidth)+1,this.worldWidth),s=Math.min(Math.floor((this.yOffset+this.CANVAS_HEIGHT)/y.tileWidth)+1,this.worldHeight);for(let d=e;d<s;d++)for(let n=i;n<l;n++){let c=n*y.tileWidth-this.xOffset,f=d*y.tileWidth-this.yOffset,u=this.worldData[d*this.worldWidth+n];this.tileMap.get(u).render(t,c,f)}}}setWorldData(t){let i=t.world,e=t.tiles,l=t.tileMap;this.staticsRegistry=t.statics,console.error(`STATICS LIST: ${JSON.stringify(this.staticsRegistry)}`);var s=atob(i["world-data"]),d=new Int8Array(s.length);for(let n=0;n<s.length;n++)d[n]=s.charCodeAt(n);this.worldName=i["World-Name"],this.worldData=d,this.worldWidth=i["world-width"],this.worldHeight=Math.floor(this.worldData.length/this.worldWidth),this.worldPixelWidth=this.worldWidth*y.tileWidth,this.worldPixelHeight=this.worldHeight*y.tileWidth,console.log(e);for(let n in e){let c=e[n];console.log(c);let f=c["code-name"],u=c.name,p=c["lore-blurb"],g=c["is-Solid"],w=c["map-color"],E=c.Sprite,m=l[f];this.tileMap.set(m,new y(this.handler,f,u,g,p,w))}console.log(`Loaded World: ${this.worldName} ${this.worldWidth}x${this.worldHeight}`)}printWorldData(){for(let t=0;t<this.worldHeight;t++){let i="";for(let e=0;e<this.worldWidth;e++)i+=this.worldData[t*this.worldWidth+e]+" ";console.log(i)}}getTileAtAbsoluteCoords(t,i){let e=Math.trunc(t/y.tileWidth),l=Math.trunc(i/y.tileWidth);return this.tileMap.get(this.worldData[l*this.worldWidth+e])}getTileAtWorldCoords(t,i){return t<0||t>=this.worldWidth||i<0||i>=this.worldHeight?null:this.tileMap.get(this.worldData[i*this.worldWidth+t])}getTileByID(t){return this.tileMap.get(t)}}});var B,at=T(()=>{R();F();B=class{constructor(t){this.handler=t,this.entities=[]}tick(){for(let t of this.entities)t.tick()}render(t){for(let i of this.entities)i.render(t)}addEntity(t){this.entities.push(t),console.log("Entity Added!")}removeEntity(t){console.log(`Removing Entities[${t} which is ${typeof this.entities[t]}]`),this.entities.splice(t,1)}getEntity(t){return this.entities[t]}getPlayerBySessionID(t){for(let i=0;i<this.entities.length;i++)if(this.entities[i]instanceof M&&this.entities[i].session_id===t)return this.entities[i];return null}getPlayerIndexBySessionID(t){return this.entities.findIndex(e=>e.session_id==t)}getPlayerCount(){let t=0;for(let i=0;i<this.entities.length;i++)(this.entities[i]instanceof M||this.entities[i]instanceof v)&&t++;return t}clearAllExceptPlayer(){for(let t=this.entities.length;t>=0;t--)this.entities[t]instanceof v||this.removeEntity(t)}}});var V,dt=T(()=>{V=class{constructor(t){this.handler=t,this.down=new Set,this.mouseX=0,this.mouseY=0}attachListeners(t,i){i(window,"keydown",e=>{this.down.add(e.code)}),i(window,"keyup",e=>{this.down.delete(e.code)}),i(t,"mousedown",e=>{e.button==0&&this.down.add("leftMouseBTN"),e.button==1&&this.down.add("rightMouseBTN"),e.button==2&&this.down.add("middleMouseBTN");let{x:l,y:s}=this._getMouseOnCanvas(e,t);this.mouseX=l,this.mouseY=s}),i(t,"mouseup",e=>{e.button==0&&this.down.delete("leftMouseBTN"),e.button==1&&this.down.delete("rightMouseBTN"),e.button==2&&this.down.delete("middleMouseBTN");let{x:l,y:s}=this._getMouseOnCanvas(e,t);this.mouseX=l,this.mouseY=s}),i(t,"mousemove",e=>{let{x:l,y:s}=this._getMouseOnCanvas(e,t);this.mouseX=l,this.mouseY=s})}_getMouseOnCanvas(t,i){let e=i.getBoundingClientRect(),l=t.clientX-e.left,s=t.clientY-e.top,d=this.handler.GAME_WIDTH/e.width,n=this.handler.GAME_HEIGHT/e.height,c=l*d,f=s*n;return{x:c,y:f}}}});var z,ct=T(()=>{z=class{constructor(t){this.handler=t,this.images=new Map}async loadAllFromServer(){let i=await(await fetch("/static-index")).json();console.log(i);let e=Object.entries(i).map(async([l,s])=>{console.log(`ATTEMPTING TO LOAD '${l}' from '${s}'`);let d=await this.loadImage(l,s)});await Promise.all(e)}loadImage(t,i){return new Promise((e,l)=>{let s=new Image;s.onload=()=>{this.images.set(t,s),e(s)},s.onerror=()=>l(new Error(`Failed to load ${i}`)),s.src=i})}get(t){return this.images.get(t)}}});var H,et=T(()=>{D();H=class extends W{constructor(t,i){super(t,i.x,i.y,40,40),this.UUID=i.UUID,this.type=i.type,this.level=i.level,this.health=i.health,this.attack=i.attack,this.attackSpeed=i.attackSpeed,this.dodgeChance=i.dodgeChance,this.criticalChance=i.criticalChance,this.movementSpeed=i.movementSpeed,this.visionRadius=i.visionRadius,this.size=i.size,this.width*=this.size,this.height*=this.size,this.movementType=i.movementType}tick(){this.renderX=this.x-this.handler.world.xOffset,this.renderY=this.y-this.handler.world.yOffset}render(t){t.fillStyle="red",t.fillRect(this.renderX,this.renderY,this.width,this.height),t.fillStyle="black",t.font="bold 20px monospace",t.fillText(this.type,this.renderX,this.renderY-5)}}});var b,it=T(()=>{D();b=class extends W{constructor(t,i,e){super(t,i.x,i.y,e.size[0],e.size[1]),console.error(`ENTITY DATA: ${i}`),this.UUID=i.UUID,this.codename=i.type,this.level=i.level,this.health=i.health,console.log(`NEW Static@${this.type} at (${this.x}, ${this.y}), UUID: ${this.UUID}`)}tick(){this.renderX=this.x-this.handler.world.xOffset,this.renderY=this.y-this.handler.world.yOffset}render(t){t.drawImage(this.handler.AM.get(this.codename),this.renderX,this.renderY,this.width,this.height),t.fillStyle="black",t.font="bold 20px monospace",t.fillText(this.handler.world.staticsRegistry[this.codename].name,this.renderX,this.renderY-5)}}});var K,ft=T(()=>{et();it();R();Y();tt();K=class{constructor(t){this.handler=t,this.packetMap={move:i=>this.move(i),login:i=>this.login(i),login_res:i=>this.login_res(i),world:i=>this.world(i),playerLOGIN:i=>this.playerLOGIN(i),playerLOGOUT:i=>this.playerLOGOUT(i),enemy:i=>this.enemy(i),static:i=>this.static(i),switch_execute:i=>this.switch_execute(i)}}processInbound(){for(let t of this.handler.net.inbound){console.log(t.data);let i=this.packetMap[t.type];i?i(t.data):console.warn(`[PacketHandler] Unhandled Packet Type "${t.type}"`)}this.handler.net.inbound.length=0}async switch_execute(t){let i=t.IP,e=t.CoordsTo;console.log(`We are going to switch worlds to ${i} at ${e[0]}, ${e[1]}`),this.handler.state=I.LOADING,this.handler.net.switchclose();let l=new k(this.handler,i);await l.waitForOpen(),this.handler.net=l,this.handler.player.x=e[0],this.handler.player.y=e[1];var s={username:this.handler.player.username,color:this.handler.player.color,x:e[0],y:e[1]};this.handler.EM.clearAllExceptPlayer(),console.log(s),this.handler.net.send("login",s),this.handler.state=I.PLAYING}login_res(t){console.log(t.nameID),this.handler.world.nameID=t.nameID}login(t){this.handler.EM.addEntity(new M(this.handler,t.x,t.y,t.session_id,t.username,t.color)),this.handler.state=I.PLAYING}authenticate(t){console.log(`LOGINVERIFY: ${t}`)}static(t){for(let i in t){console.log(this.handler.world.staticsRegistry),console.error(`${i} => ${JSON.stringify(t[i])}`);let e=t[i].type;console.log(e);let l=this.handler.world.staticsRegistry[e];console.log(`Size: ${l.size[0]}, ${l.size[1]}`),this.handler.EM.addEntity(new b(this.handler,t[i],l))}}move(t){console.log(t);let i=this.handler.EM.getPlayerBySessionID(t.UUID);i!=null&&(i.x=t.x,i.y=t.y)}world(t){this.handler.world.setWorldData(t)}playerLOGIN(t){this.handler.EM.addEntity(new M(this.handler,t.x,t.y,t.session_id,t.username,t.color))}enemy(t){for(let i in t)this.handler.EM.addEntity(new H(this.handler,t[i]))}playerLOGOUT(t){this.handler.EM.removeEntity(this.handler.EM.getPlayerIndexBySessionID(t.session_id))}}});var J,mt=T(()=>{et();R();F();it();U();J=class{constructor(t){this.handler=t}tick(){}render(t,i){let e=this.handler.GAME_WIDTH,l=this.handler.GAME_HEIGHT;if(this.handler.world==null||this.handler.world.xOffset==null||this.handler.player==null)return;let s=this.handler.EM.getPlayerCount(),d=this.handler.world.nameID,n="player";s>1&&(n="players");let c=`${s} ${n} in ${d}`;t.font="32px monospace";let u=t.measureText(c).width,p=32,g=12,w=6,E=u+g*2,m=p+w*2,x=e-E,G=l-m;if(t.fillStyle="rgba(81,81,71,0.68)",t.fillRect(x,G,E,m),t.fillStyle="yellow",t.fillText(c,x+g,G+p+w-4),!this.handler.CM.controls.get("TOGGLEDEBUG").toggled())return;let A=this.handler.world.xOffset+this.handler.IM.mouseX,N=this.handler.world.yOffset+this.handler.IM.mouseY;t.fillStyle="black",t.font=" 20px monospace";let h=21;t.fillStyle="rgba(255, 255, 223, 0.55)",t.fillRect(0,0,220,11*h+8),t.fillStyle="black",t.fillText("Ticks: "+i,8,8+2*h),t.fillText(`Player: (${this.handler.player.x.toFixed(1)},${this.handler.player.y.toFixed(1)})`,8,8+5*h),t.fillText(`Offset: (${this.handler.world.xOffset.toFixed(1)},${this.handler.world.yOffset.toFixed(1)})`,8,8+6*h),t.fillText(`Mouse: (${this.handler.IM.mouseX.toFixed(1)},${this.handler.IM.mouseY.toFixed(1)})`,8,8+7*h),t.fillText(`MseAdj: (${A.toFixed(1)},${N.toFixed(1)})`,8,8+8*h);let Mt=Math.trunc((this.handler.world.xOffset+this.handler.IM.mouseX)/y.tileWidth),St=Math.trunc((this.handler.world.yOffset+this.handler.IM.mouseY)/y.tileWidth);t.fillText(`Mouse (Tile): (${Mt},${St})`,8,8+9*h);for(let o of this.handler.EM.entities)if(o.x<A&&A<o.x+o.width&&o.y<N&&N<o.y+o.height){if(o.renderDebug(t),t.fillStyle="black",t.font=" 20px monospace",o instanceof M||o instanceof v){let r=300,S=h*6;t.fillStyle="rgba(255, 255, 223, 0.55)",t.fillRect(e-r,0,r,S),t.lineWidth=2,t.fillStyle="black",t.strokeRect(e-r+1,1,r-2,S-2),t.fillText(`EntityType: ${o.constructor.name}`,e-r+4,18+h*0),t.fillText(`(x,y): (${o.x.toFixed(1)},${o.y.toFixed(1)})`,e-r+4,18+h*1),t.fillText(`w x h: ${o.width} x ${o.height}`,e-r+4,18+h*2),t.fillText(`Name: ${o.username}`,e-r+4,18+h*3),t.fillText(`Color: ${o.color}`,e-r+4,18+h*4),o instanceof M&&t.fillText(`SessID: ${o.session_id}`,e-r+4,18+h*5)}else if(o instanceof H){let r=300,S=h*18+10;t.fillStyle="rgba(255, 255, 223, 0.55)",t.fillRect(e-r,0,r,S),t.lineWidth=2,t.fillStyle="black",t.strokeRect(e-r+1,1,r-2,S-2),t.fillText(`EntityType: ${o.constructor.name}`,e-r+4,18+h*0),t.fillText(`(x,y): (${o.x.toFixed(1)},${o.y.toFixed(1)})`,e-r+4,18+h*1),t.fillText(`w x h: ${o.width} x ${o.height}`,e-r+4,18+h*2),t.fillText(`UUID ${o.UUID}`,e-r+4,18+h*6),t.fillText(`Type: ${o.type}`,e-r+4,18+h*7),t.fillText(`Level: ${o.level}`,e-r+4,18+h*8),t.fillText(`Health: ${o.health}`,e-r+4,18+h*9),t.fillText(`AttackDMG: ${o.attack}`,e-r+4,18+h*10),t.fillText(`AttackSPD: ${o.attackSpeed}`,e-r+4,18+h*11),t.fillText(`dodge: ${o.dodgeChance}`,e-r+4,18+h*12),t.fillText(`critical: ${o.criticalChance}`,e-r+4,18+h*13),t.fillText(`movementSPD: ${o.movementSpeed}`,e-r+4,18+h*14),t.fillText(`VisionRadius: ${o.visionRadius}`,e-r+4,18+h*15),t.fillText(`Size: ${o.size}`,e-r+4,18+h*16),t.fillText(`movementType: ${o.movementType}`,e-r+4,18+h*17)}else if(o instanceof b){let r=300,S=h*18+10;t.fillStyle="rgba(255, 255, 223, 0.55)",t.fillRect(e-r,0,r,S),t.lineWidth=2,t.fillStyle="black",t.strokeRect(e-r+1,1,r-2,S-2),t.fillText(`EntityType: ${o.constructor.name}`,e-r+4,18+h*0),t.fillText(`(x,y): (${o.x.toFixed(1)},${o.y.toFixed(1)})`,e-r+4,18+h*1),t.fillText(`w x h: ${o.width} x ${o.height}`,e-r+4,18+h*2),t.fillText(`UUID ${o.UUID}`,e-r+4,18+h*6),t.fillText(`Type: ${o.type}`,e-r+4,18+h*7),t.fillText(`Level: ${o.level}`,e-r+4,18+h*8),t.fillText(`Health: ${o.health}`,e-r+4,18+h*9);let C=this.handler.world.staticsRegistry[o.codename];t.fillText(`Name: ${C.name}`,e-r+4,18+h*10),t.fillText(`lore: ${C["lore-blurb"]}`,e-r+4,18+h*11),t.fillText(`code-name: ${o.codename}`,e-r+4,18+h*13)}return}if(this.handler.world.worldData!=null){let o=300,r=h*5+10;t.fillStyle="rgba(255, 255, 223, 0.55)",t.fillRect(e-o,0,o,r),t.lineWidth=2,t.fillStyle="black",t.strokeRect(e-o+1,1,o-2,r-2);let S=Math.trunc(A/y.tileWidth),C=Math.trunc(N/y.tileWidth),P=this.handler.world.getTileAtWorldCoords(S,C);if(P){let It=S*y.tileWidth-this.handler.world.xOffset,At=C*y.tileWidth-this.handler.world.yOffset;P.renderDebug(t,It,At),t.fillStyle="black",t.font=" 20px monospace",t.fillText(`codename: ${P.codename}`,e-o+4,18+h*0),t.fillText(`(x,y): (${S},${C})`,e-o+4,18+h*1),t.fillText(`Name: ${P.name}`,e-o+4,18+h*2),t.fillText(`loreBlurb: ${P.loreBlurb}`,e-o+4,18+h*3),t.fillText(`isSolid: ${P.isSolid}`,e-o+4,18+h*4)}}}}});var $,ut=T(()=>{$=class{constructor(t,i,e){this.handler=t,this.name=i,this.keyCode=e,this.isPressed=!1}tick(){this.handler.IM.down.has(this.keyCode)?this.isPressed=!0:this.isPressed=!1}setKeyCode(t){this.keyCode=t}down(){return this.isPressed}}});var j,gt=T(()=>{j=class{constructor(t,i,e){this.handler=t,this.name=i,this.keyCode=e,this.alreadyCounted=!1,this.isToggled=!1}setKeyCode(t){this.keyCode=t}tick(){this.handler.IM.down.has(this.keyCode)?this.alreadyCounted||(this.isToggled?(this.isToggled=!1,this.alreadyCounted=!0):(this.isToggled=!0,this.alreadyCounted=!0)):this.alreadyCounted=!1}toggled(){return this.isToggled}}});var q,wt=T(()=>{ut();gt();q=class{constructor(t){this.handler=t,this.controls=new Map,this.controls.set("LEFT",new $(t,"LEFT","KeyA")),this.controls.set("UP",new $(t,"UP","KeyW")),this.controls.set("DOWN",new $(t,"DOWN","KeyS")),this.controls.set("RIGHT",new $(t,"RIGHT","KeyD")),this.controls.set("TOGGLEDEBUG",new j(t,"TOGGLEDEBUG","KeyF"))}tick(){for(let[t,i]of this.controls)i.tick()}}});var L,st=T(()=>{L=class{constructor(t){this.handler=t}tick(){}render(t){}}});var Q,yt=T(()=>{st();Q=class extends L{constructor(t){super(t)}tick(){}render(t){t.fillStyle="blue",t.fillRect(0,0,this.handler.GAME_WIDTH,this.handler.GAME_HEIGHT)}}});var Z,pt=T(()=>{st();Z=class extends L{constructor(t){super(t)}tick(){this.handler.PH.processInbound(),this.handler.CM.tick(),this.handler.world.tick(),this.handler.EM.tick()}render(t,i){this.handler.world.render(t),this.handler.EM.render(t),this.handler.debug.render(t,i)}}});var I,lt,vt,Tt,Y=T(()=>{ht();F();nt();at();dt();ct();ft();mt();wt();yt();pt();console.log("Loading GameLoop.js!");I={PLAYING:"Playing",LOADING:"Loading"},lt=class{init(t,i,e){this.handler=new _,t.handler=this.handler;let l=new v(this.handler,i,e),s=new X(this.handler),d=new B(this.handler),n=new V(this.handler),c=new q(this.handler),f=new z(this.handler),u=new J(this.handler),p=new K(this.handler);this.GamestateState=new Z(this.handler),this.LoadingState=new Q(this.handler),this.handler.init(this,t,l,s,d,n,c,p,f,u),this.handler.EM.addEntity(l),this._rafID=0,this._listeners=[],this._dead=!1,this.canvas=document.getElementById("myCanvas"),this.ctx=this.canvas.getContext("2d"),this.st=0,this.targetTPS=60,this.MSPT=1e3/this.targetTPS,this.tickTimer=0,this.ticksLastSecond=0,this.ticks=0,this.dt=0;let g=()=>{let m=this.canvas.style;m.position="fixed",m.left="50%",m.top="50%",m.transform="translate(-50%, -50%)"},w=()=>{let m=Math.floor(window.innerWidth*1),x=Math.floor(window.innerHeight*1);this.canvas.style.width=m+"px",this.canvas.style.height=x+"px";let G=window.devicePixelRatio||1,A=Math.max(1,Math.round(G));this.canvas.width=m*A,this.canvas.height=x*A,this.ctx.setTransform(A,0,0,A,0,0),this.ctx.imageSmoothingEnabled=!1,this.handler.updateSize(m,x),console.log(`NEW DPR ${G} adj:${A}`),console.log(`cssW x cssH ${m} x ${x}`),console.log(`canvasWidth x canvasHeight ${this.canvas.width} x ${this.canvas.height}`)};this.on(window,"resize",m=>{g(),w()}),g(),w(),this.handler.IM.attachListeners(this.canvas,this.on),f.loadAllFromServer().then(()=>{console.log("Done Loading Assets!"),this.handler.state=I.PLAYING,this.last=performance.now(),this.gameLoopFunction=this.gameLoop.bind(this),this._rafID=requestAnimationFrame(this.gameLoopFunction)})}on=(t,i,e,l)=>(t.addEventListener(i,e,l),this._listeners.push([t,i,e,l]),e);offAll(){for(let[t,i,e,l]of this._listeners)t.removeEventListener(i,e,l);this._listeners.length=0}tick(){switch(this.handler.state){case I.LOADING:this.LoadingState.tick();break;case I.PLAYING:this.GamestateState.tick();break}}render(){if(!(!this.ctx||!this.canvas))switch(this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.handler.state){case I.LOADING:this.LoadingState.render(this.ctx);break;case I.PLAYING:this.GamestateState.render(this.ctx,this.ticksLastSecond);break}}gameLoop(t){this._dead||(this.dt=t-this.last,this.st+=this.dt,this.tickTimer=Math.min(this.tickTimer+=this.dt,this.MSPT*4),this.tickTimer>this.MSPT&&(this.tick(),this.ticks++,this.tickTimer-=this.MSPT),this.last=t,this.st>1e3&&(this.st=0,this.ticksLastSecond=this.ticks,this.ticks=0),this.render(),this.dt=0,this._rafID=requestAnimationFrame(this.gameLoopFunction))}stop=t=>{let i=document.getElementById("game"),e=document.getElementById("loginPage"),l=document.getElementById("loginForm");if(i.hidden=!0,e.hidden=!1,l.reset(),this._dead)return;this._dead=!0,this._rafID&&(cancelAnimationFrame(this._rafID),this._rafID=0),this.offAll(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx=null,this.canvas=null,this.handler=null,console.log("STOPPED GAME LOOP!!!!!!!!!!!!");let s=document.getElementById("msg");s.style.visibility="visible",s.textContent=`${t.code} ${t.reason}`}},vt=new lt,Tt=vt});var $t=Wt(()=>{tt();Y();console.log("Loaded app.js");var ot=document.querySelector(".color"),Et=document.getElementById("cv");function xt(){Et.textContent=ot.value,Et.style.color=ot.value}ot.addEventListener("input",xt);xt();var Ot=document.querySelector(".ippicker"),rt=document.getElementById("customServer");function kt(){O.choices.value==="Custom"?rt.style.display="inline-block":rt.style.display="none"}Ot.addEventListener("input",kt);var O=document.getElementById("loginForm");O.addEventListener("submit",async a=>{a.preventDefault();let t=O.choices.value;t==="Custom"&&(t=rt.value),console.log(`IPPORT: ${t}`);let i={username:O.username.value,password:O.password.value};console.log(i);let e=new k(null,t);await e.waitForOpen(),e.send("AUTH_REQ",i);let l=await e.waitForLoginVerify(d=>d.data.AUTH==="AUTH_OK"||d.data.AUTH==="AUTH_FAILED",5e3);if(console.log(JSON.stringify(l)),e.close(),l.data.AUTH==="AUTH_OK"){let d=l.data.IP,n=new k(null,d);await n.waitForOpen();var s={username:O.username.value,color:O.color.value};console.log(s),n.send("login",s),game.hidden=!1,loginPage.hidden=!0,Tt.init(n,O.username.value,O.color.value)}})});$t();})();
